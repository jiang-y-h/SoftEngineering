<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>计划任务管理</title>
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/static/css/global.css" media="all">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">
    <style>
        body {
            background-color: #f2f2f2;
            font-family: Arial, sans-serif;
        }
        .container {
            margin: 2% auto;
            width: 90%;
        }
        .form-section, .task-list-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-section h2, .task-list-section h2 {
            margin-bottom: 20px;
        }
        .form-section form, .task-list-section table {
            width: 100%;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-item label {
            display: block;
            font-weight: bold;
        }
        .form-item input, .form-item select, .form-item textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-item button {
            background-color: #1E9FFF;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-item button.reset {
            background-color: #FF5722;
        }
        .task-list-section table {
            width: 100%;
            border-collapse: collapse;
        }
        .task-list-section th, .task-list-section td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .task-list-section th {
            background-color: #f5f5f5;
        }
        .task-list-section td a {
            color: #1E9FFF;
            text-decoration: none;
        }
        .task-list-section td a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-section">
            <h2>新建任务</h2>
            <form class="layui-form">
                <input type="hidden" name="type" value="senc">
                <div class="form-item">
                    <label for="senc">间隔秒数</label>
                    <input type="number" name="senc" lay-verify="number" autocomplete="off" placeholder="请输入间隔秒数">
                </div>
                <div class="form-item">
                    <label for="value">Shell 内容</label>
                    <textarea name="value" placeholder="请输入 Shell 内容"></textarea>
                </div>
                <div class="form-item">
                    <button type="submit" lay-submit lay-filter="taskSenc">立即提交</button>
                    <button type="reset" class="reset">重置</button>
                </div>
            </form>
        </div>

        <div class="form-section">
            <h2>设定周期循环任务</h2>
            <form class="layui-form">
                <div class="form-item">
                    <label for="type">周期类型</label>
                    <select name="type">
                        <option value="">请选择</option>
                        <option value="day">每天</option>
                        <option value="week">每周</option>
                        <option value="month">每月</option>
                        <option value="once">仅一次</option>
                    </select>
                </div>
                <div id='taskType'></div>
                <div class="form-item">
                    <label for="hour">设定时间</label>
                    <input type="number" name="hour" lay-verify="number" placeholder="时" max="23">
                    <input type="number" name="mint" lay-verify="number" placeholder="分" max="59">
                    <input type="number" name="senc" lay-verify="number" placeholder="秒" max="59">
                </div>
                <div class="form-item">
                    <label for="value">Shell 内容</label>
                    <textarea name="value" placeholder="请输入 Shell 内容"></textarea>
                </div>
                <div class="form-item">
                    <button type="submit" lay-submit lay-filter="taskOther">立即提交</button>
                    <button type="reset" class="reset">重置</button>
                </div>
            </form>
        </div>

        <div class="task-list-section">
            <h2>已创建的计划任务</h2>
            <table>
                <thead>
                    <tr>
                        <th>创建时间</th>
                        <th>计划类型</th>
                        <th>计划时间</th>
                        <th>Shell 内容</th>
                        <th>下次执行时间</th>
                        <th>删除计划任务</th>
                    </tr>
                </thead>
                <tbody id="dataList"></tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="/static/js/ffevent.js"></script>
    <script type="text/javascript" src="/static/plugins/layui/layui.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <script>
        function GetTaskList() {
            $.ajax({
                type: "POST",
                dataType: "html",
                url: '/SelectTask',
                success: function (data) {
                    var result = jQuery.parseJSON(data);
                    var hem = '';
                    $.each(result.result, function (i, item) {
                        hem += "<tr><td>" + item.creatTime + "</td>";
                        //类型
                        var t = '';
                        var te = '';
                        if (item.type == 'day') {
                            t = '每日任务';
                            te = '每日 ' + item.hour + ':' + item.mint + ':' + item.senc
                        } else if (item.type == 'week') {
                            t = '每周任务';
                            te = '每周' + item.week + ' ' + item.hour + ':' + item.mint + ':' + item.senc
                        } else if (item.type == 'month') {
                            t = '每月任务';
                            te = '每月' + item.day + '日 ' + item.hour + ':' + item.mint + ':' + item.senc
                        } else if (item.type == 'once') {
                            t = '仅一次';
                            te = item.year + '年' + item.month + '月' + item.day + '日 ' + item.hour + ':' + item.mint + ':' + item.senc
                        } else {
                            t = '时间循环';
                            te = '每' + item.senc + '秒'
                        }
                        hem += "<td>" + t + "</td>";
                        hem += "<td>" + te + "</td>";
                        if (item.value.length > 20) {
                            hem += "<td><a style='color:#1AA094' href='javascript:void(0);' title='" + item.value + "' onclick='alertTtl()' id='" + item.taskID + "'>" + item.value.slice(0, 20) + "...</a></td>";
                        } else {
                            hem += "<td>" + item.value + "</td>";
                        };
                        hem += "<td>" + item.nextRunTime + "</td>";
                        hem += "<td><a style='color:#1AA094' href='javascript:void(0);' onclick='DeleteTask()' id='" + item.taskID + "'>删除</a></td></tr>";
                    });
                    document.getElementById("dataList").innerHTML = hem;
                }
            });
        };

        function DeleteTask() {
            var taskid = event.srcElement.id;
            $.ajax({
                type: "POST",
                dataType: "html",
                url: '/DeleteTask',
                data: { 'taskid': taskid },
                success: function (data) {
                    resultCode = jQuery.parseJSON(data).resultCode;
                    if (resultCode == '0') {
                        layer.msg('删除成功');
                        GetTaskList();
                    } else {
                        layer.alert(jQuery.parseJSON(data).result, { title: false, skin: "layui-layer-molv", area: ["250px", "150px"], time: 10000, btn: ["知道了"] })
                    }
                }
            });
        };

        layui.use(['form', 'layedit', 'laydate'], function () {
            var form = layui.form,
                layer = layui.layer,
                layedit = layui.layedit,
                laydate = layui.laydate;
            var $ = layui.$;

            form.on('submit(taskSenc)', function (data) {
                data = data.field;
                $.ajax({
                    url: '/CreatTask',
                    dataType: "html",
                    type: "POST",
                    data: data,
                    success: function (data) {
                        resultCode = jQuery.parseJSON(data).resultCode;
                        if (resultCode == '0') {
                            layer.msg('设定成功');
                            GetTaskList();
                        } else {
                            layer.alert(jQuery.parseJSON(data).result, { title: false, skin: "layui-layer-molv", area: ["250px", "150px"], time: 10000, btn: ["知道了"] });
                        }
                    }
                });
                return false;
            });

            form.on('submit(taskOther)', function (data) {
                data = data.field;
                $.ajax({
                    url: '/CreatTask',
                    dataType: "html",
                    type: "POST",
                    data: data,
                    success: function (data) {
                        resultCode = jQuery.parseJSON(data).resultCode;
                        if (resultCode == '0') {
                            layer.msg('设定成功');
                            GetTaskList();
                        } else {
                            layer.alert(jQuery.parseJSON(data).result, { title: false, skin: "layui-layer-molv", area: ["250px", "150px"], time: 10000, btn: ["知道了"] });
                        }
                    }
                });
                return false;
            });

            form.on("select", function (data) {
                var strVar = "";
                if (data.value == 'week') {
                    strVar += "<div class=\"form-item\"><label for=\"week\">每周</label><input type=\"number\" name=\"week\" lay-verify=\"number\" placeholder=\"每周几, 则输入几\" autocomplete=\"off\" max=\"7\"></div>";
                } else if (data.value == 'month') {
                    strVar += "<div class=\"form-item\"><label for=\"day\">日期</label><input type=\"number\" name=\"day\" lay-verify=\"number\" placeholder=\"每月的几号, 则输入几\" autocomplete=\"off\" max=\"31\"></div>";
                } else if (data.value == 'once') {
                    strVar += "<div class=\"form-item\"><label for=\"year\">年</label><input type=\"number\" name=\"year\" lay-verify=\"number\" placeholder=\"哪年\" autocomplete=\"off\"></div>";
                    strVar += "<div class=\"form-item\"><label for=\"month\">月</label><input type=\"number\" name=\"month\" lay-verify=\"number\" placeholder=\"哪个月\" autocomplete=\"off\"></div>";
                    strVar += "<div class=\"form-item\"><label for=\"day\">日</label><input type=\"number\" name=\"day\" lay-verify=\"number\" placeholder=\"哪天\" autocomplete=\"off\" max=\"31\"></div>";
                }
                document.getElementById("taskType").innerHTML = strVar;
                form.render();  // 重新渲染表单
            });
        });

        GetTaskList();
    </script>
</body>
</html>
